name: Pattern Compliance

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  check-patterns:
    runs-on: ubuntu-latest
    name: Check Pattern Compliance

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.0'
          coverage: none

      - name: Get Changed Pattern Files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: patterns/*.php

      - name: Skip Check (No Pattern Changes)
        if: steps.changed-files.outputs.any_changed != 'true'
        run: |
          echo "âœ… No pattern files were modified in this change."
          echo "Skipping pattern compliance checks."

      - name: Run Pattern Compliance Checks
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "ðŸ” Checking only modified pattern files:"
          echo "${{ steps.changed-files.outputs.all_changed_files }}"
          echo ""

          cat > /tmp/pattern-checker.php << 'CHECKER_EOF'
          <?php
          /**
           * Pattern Compliance Checker for Elayne Theme
           *
           * Checks patterns against CLAUDE.md rules for code quality and WordPress standards.
           *
           * @package Elayne
           * @since 1.0.0
           */

          /**
           * Pattern Compliance Checker class
           *
           * Checks patterns against CLAUDE.md rules:
           * - No hardcoded font sizes, padding, or border-radius (relaxed for templates)
           * - Proper semantic variables usage
           * - No spacer blocks
           * - Proper margin reset on full-width patterns
           * - Valid block comment structure
           * - Responsive grid layouts for 3+ columns
           *
           * Template Exception Rules:
           * - Templates (template-*, header-*, footer-*) are allowed WordPress Core defaults
           * - Allowed in templates: border-radius:5px, border-radius:100px, blockGap:0.5rem/10px
           * - These are WordPress Core block defaults for comments, avatars, and metadata
           */
          class PatternComplianceChecker {
          	/**
          	 * Pattern directory path
          	 *
          	 * @var string
          	 */
          	private $pattern_dir;

          	/**
          	 * Array of compliance issues
          	 *
          	 * @var array
          	 */
          	private $issues = array();

          	/**
          	 * Array of patterns that passed
          	 *
          	 * @var array
          	 */
          	private $passed = array();

          	/**
          	 * Constructor
          	 *
          	 * @param string $pattern_dir Path to patterns directory.
          	 */
          	public function __construct( $pattern_dir ) {
          		$this->pattern_dir = rtrim( $pattern_dir, '/' );
          	}

          	/**
          	 * Check specific pattern files
          	 *
          	 * @param array $files Optional array of specific files to check.
          	 * @return void
          	 */
          	public function check_all_patterns( $files = array() ) {
          		if ( empty( $files ) ) {
          			$patterns = glob( $this->pattern_dir . '/*.php' );
          		} else {
          			$patterns = $files;
          		}

          		foreach ( $patterns as $pattern_file ) {
          			$pattern_name = basename( $pattern_file );
          			$content = file_get_contents( $pattern_file );

          			$issues = array();

          			// Determine if this is a template pattern (different rules apply).
          			$is_template   = 0 === strpos( $pattern_name, 'template-' );
          			$is_header     = 0 === strpos( $pattern_name, 'header-' );
          			$is_footer     = 0 === strpos( $pattern_name, 'footer-' );
          			$is_structural = $is_template || $is_header || $is_footer;

          			// Check for hardcoded values
          			// Templates are allowed specific WordPress Core defaults:
          			// - border-radius:5px (comment boxes)
          			// - border-radius:100px (avatars)
          			// - blockGap:0.5rem or 10px (metadata spacing).
          			if ( $is_structural ) {
          				// For templates: only check for hardcoded font-size and large spacing values
          				// Allow small border-radius and blockGap values (WordPress Core defaults).
          				if ( preg_match( '/(font-size):\s*\d+\.?\d*(px|rem|em)/', $content ) ) {
          					$issues[] = 'Hardcoded font-size values found (use semantic variables)';
          				}
          				// Flag large padding/margin values but allow WordPress Core defaults.
          				if ( preg_match( '/(padding|margin):\s*\d{2,}\.?\d*(px|rem|em)/', $content ) ) {
          					// Exclude common WordPress Core spacing patterns.
          					if ( ! preg_match( '/margin-(top|bottom|left|right):0/', $content ) ) {
          						$issues[] = 'Hardcoded large spacing values found (use semantic variables)';
          					}
          				}
          			} elseif ( preg_match( '/(font-size|padding|margin|border-radius):\s*\d+\.?\d*(px|rem|em)/', $content ) ) {
          				// For content patterns: strict checking (all hardcoded values).
          				$issues[] = 'Hardcoded CSS values found (use semantic variables)';
          			}

          			// Check for spacer blocks.
          			if ( false !== strpos( $content, '<!-- wp:spacer ' ) ) {
          				$issues[] = 'Spacer blocks found (use blockGap instead)';
          			}

          			// Check for emoji icons.
          			if ( preg_match( '/[ðŸ…¿ðŸ½ðŸ“¶â™¿ðŸŽ‰ðŸ·ðŸ…¿ï¸ðŸ½ï¸ðŸ“¶ï¸â™¿ï¸ðŸŽ‰ï¸ðŸ·ï¸]/u', $content ) ) {
          				$issues[] = 'Emoji icons found (use SVG icons instead)';
          			}

          			// Check for HTML comments between tags
          			// Only flag organizational HTML comments (not WordPress block comments)
          			// Problematic: <div>\n<!-- Attorney 1 -->\n<!-- wp:group
          			// Valid: <div><!-- wp:avatar /-->\n<!-- wp:group
          			// Valid: <div><!-- /wp:image -->\n<!-- wp:group
          			// Match: <div> followed by whitespace, then comment NOT starting with "wp:" or "/wp:".
          			if ( preg_match( '/<div[^>]*>\s+<!--\s*(?!\/?\s*wp:)[^-]/', $content ) ) {
          				$issues[] = 'HTML comments between opening tags and block comments (causes validation errors)';
          			}

          			// Check for proper margin reset on full-width patterns.
          			if ( false !== strpos( $content, 'alignfull' ) &&
          				( false === strpos( $content, '"margin":{"top":"0","bottom":"0"}' ) &&
          				false === strpos( $content, 'margin-top:0;margin-bottom:0' ) ) ) {
          				$issues[] = 'Full-width pattern missing margin reset';
          			}

          			// Check for wp:columns in 3+ column grid patterns
          			// Note: wp:columns is acceptable for 2-column layouts (they stack to 1)
          			// Only flag when there are 3+ columns in CONTENT patterns (not templates).
          			if ( ! $is_structural && false !== strpos( $content, 'wp:columns' ) ) {
          				// Count the number of column blocks.
          				preg_match_all( '/<!-- wp:column/', $content, $matches );
          				if ( count( $matches[0] ) >= 3 ) {
          					$issues[] = 'Using wp:columns for 3+ columns instead of responsive grid layout (use minimumColumnWidth)';
          				}
          			}

          			// Check for hardcoded media IDs.
          			if ( preg_match( '/"id":\d+/', $content ) ) {
          				$issues[] = 'Hardcoded media IDs found';
          			}

          			if ( empty( $issues ) ) {
          				$this->passed[] = $pattern_name;
          			} else {
          				$this->issues[ $pattern_name ] = $issues;
          			}
          		}
          	}

          	/**
          	 * Get check results
          	 *
          	 * @return array Results with 'passed' and 'issues' keys.
          	 */
          	public function get_results() {
          		return array(
          			'passed' => $this->passed,
          			'issues' => $this->issues,
          		);
          	}

          	/**
          	 * Print results to console
          	 *
          	 * @return void
          	 */
          	public function print_results() {
          		$results = $this->get_results();

          		echo "\n=== Pattern Compliance Check Results ===\n\n";

          		echo 'âœ… PASSED (' . count( $results['passed'] ) . " patterns):\n";
          		foreach ( $results['passed'] as $pattern ) {
          			echo '  - ' . $pattern . "\n";
          		}

          		if ( ! empty( $results['issues'] ) ) {
          			echo "\nâŒ ISSUES FOUND (" . count( $results['issues'] ) . " patterns):\n";
          			foreach ( $results['issues'] as $pattern => $issues ) {
          				echo "\n  " . $pattern . ":\n";
          				foreach ( $issues as $issue ) {
          					echo '    - ' . $issue . "\n";
          				}
          			}
          		} else {
          			echo "\nðŸŽ‰ All patterns passed compliance checks!\n";
          		}

          		echo "\n";
          	}
          }

          // Run the checker.
          if ( 'cli' === php_sapi_name() ) {
          	// Get specific files from command line arguments (space-separated)
          	$files = array_slice( $argv, 1 );

          	if ( empty( $files ) ) {
          		die( "No pattern files specified.\n" );
          	}

          	// Verify all files exist
          	foreach ( $files as $file ) {
          		if ( ! file_exists( $file ) ) {
          			die( "Pattern file not found: " . $file . "\n" );
          		}
          	}

          	$checker = new PatternComplianceChecker( '.' );
          	$checker->check_all_patterns( $files );
          	$checker->print_results();

          	// Exit with error code if issues found.
          	$results = $checker->get_results();
          	exit( empty( $results['issues'] ) ? 0 : 1 );
          } else {
          	die( "This script must be run from CLI.\n" );
          }
          CHECKER_EOF

          # Run checker on changed files only
          php /tmp/pattern-checker.php ${{ steps.changed-files.outputs.all_changed_files }}
